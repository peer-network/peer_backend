#!/usr/bin/env bash
set -euo pipefail

msg_file="$1"
first_line=$(sed -n '1p' "$msg_file" | tr -d '\r')

# Allow common non-conventional commits created by Git tools
if printf '%s\n' "$first_line" | grep -qE '^(Merge|Revert|fixup!|squash!)\b'; then
  exit 0
fi

# Basic empty check
if [[ -z "$first_line" ]]; then
  echo "Commit message cannot be empty." >&2
  exit 1
fi

# Conventional Commit validation
types='feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert'

# ERE: type(scope)?!?: subject
# - scope: a-z, 0-9, dot, underscore, hyphen, slash
ere="^(${types})(\([a-z0-9._/-]+\))?(!)?: .+"

if ! printf '%s\n' "$first_line" | LC_ALL=C grep -Eq -- "$ere"; then
  cat >&2 <<ERR
❌ Invalid commit message format.

Got:      "$first_line"
Expected: <type>(scope?): <subject>
Example:  feat(api): add user search endpoint
Also OK:  feat!: breaking change
          feat(api)!: breaking change

Allowed types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert

Tip: Use the provided template for guidance:
  git config commit.template .gitmessage
Then run:
  git commit
ERR
  exit 1
fi

# Soft guideline: keep the first line <= 72 characters
subject_len=${#first_line}
if (( subject_len > 72 )); then
  echo "⚠️  Subject is ${subject_len} chars; keep it <= 72 if possible." >&2
fi

exit 0
