#!/bin/sh
echo "Running Gitleaks pre-commit scan on staged changes..."

mkdir -p .gitleaks_out

git diff --cached --unified=0 --no-color | \
  docker run --rm -i -v "$(pwd)":/repo ghcr.io/gitleaks/gitleaks:v8.28.0 \
    detect \
      --pipe \
      --config=/repo/gitleaks.toml \
      --report-format=json \
      --report-path=/repo/.gitleaks_out/gitleaks-precommit.json \
      --no-banner

status=$?

if [ $status -ne 0 ]; then
  echo "Possible secrets detected! See .gitleaks_out/gitleaks-precommit.json"
  echo "Commit aborted. Contact Backend Lead/CTO/DevOps if this is intentional."
  echo "Tip: You can also run 'make scan' or 'make scan-staged' manually to debug."
  exit 1
fi

echo "No secrets found. Commit allowed."
exit 0
